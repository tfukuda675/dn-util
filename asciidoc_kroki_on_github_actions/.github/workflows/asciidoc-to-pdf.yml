name: AsciiDoc to PDF with Kroki

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  convert-to-pdf:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Podman
      run: |
        sudo apt-get update
        sudo apt-get install -y podman
        
    - name: Start Kroki server
      run: |
        podman run -d --name kroki -p 8000:8000 yuzutech/kroki
        sleep 30
        
    - name: Verify Kroki is running
      run: |
        curl -f http://localhost:8000/health || exit 1
        
    - name: Install AsciiDoctor and dependencies
      run: |
        sudo gem install asciidoctor
        sudo gem install asciidoctor-pdf
        sudo gem install asciidoctor-kroki
        
    - name: Install Japanese fonts
      run: |
        sudo apt-get install -y fonts-noto-cjk
        
    - name: Convert AsciiDoc to PDF
      run: |
        chmod +x ./scripts/convert-to-pdf.sh
        ./scripts/convert-to-pdf.sh
        
    - name: Upload PDF artifacts
      uses: actions/upload-artifact@v4
      with:
        name: generated-pdfs
        path: output/*.pdf
        
    - name: Stop Kroki server
      if: always()
      run: |
        podman stop kroki || true
        podman rm kroki || true